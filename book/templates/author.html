{% extends "base.html" %}
{% block content %}

{% if request.GET.message %}
    <div class="alert alert-success alert-dismissible fade show" role="alert">
        {% if request.GET.message == 'new_work' %}
            Added new work "{{ request.GET.title }}" to your library
        {% elif request.GET.message == 'new_copy' %}
            Added another copy of "{{ request.GET.title }}" to your library
        {% elif request.GET.message == 'new_copy_shelved' %}
            Added "{{ request.GET.title }}" to your library and shelved at {{ request.GET.location }}
        {% endif %}
        <button type="button" class="close" data-dismiss="alert" aria-label="Close">
            <span aria-hidden="true">&times;</span>
        </button>
    </div>
{% endif %}

<div class="container bg-light p-4 rounded shadow-sm">
    <div class="row mb-4">
        <div class="col-12 d-flex justify-content-between align-items-center">
            <h2 class="mb-0">Add a Book</h2>
            <a href="{% url 'get_book_by_isbn' %}" class="btn btn-primary">
                <i class="fas fa-barcode me-2"></i>Add by ISBN
            </a>
        </div>
    </div>

    <div class="row">
        <div class="col-md-8">
            <div class="form-check mb-3">
                <input type="checkbox" class="form-check-input" id="isEditor" name="is_editor" 
                       {% if is_editor %}checked{% endif %}>
                <label class="form-check-label" for="isEditor">
                    This person is an editor (not author)
                </label>
            </div>
            
            <div class="mb-4">
                <h5>Enter {{ is_editor|yesno:"Editor,Author" }} Name</h5>
                <p class="text-muted">Type at least three characters for suggestions to appear</p>
                
                <form action="/author/" method="post" class="mt-3">
                    {% csrf_token %}
                    {{ form }}
                    <input type="hidden" name="author_role" id="authorRole" value="{{ author_role }}">
                    <button type="submit" class="btn btn-success mt-3">Continue</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Add required scripts in correct order -->
<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
<script src="https://cdn.jsdelivr.net/gh/xcash/bootstrap-autocomplete@v2.3.7/dist/latest/bootstrap-autocomplete.min.js"></script>

<script>
    $(function () {
        // Debug logging
        console.log("Initial author_role value:", $('#authorRole').val());
        console.log("Initial isEditor checked state:", $('#isEditor').prop('checked'));
        
        // Initialize autocomplete
        $('.basicAutoComplete').autoComplete({
            resolverSettings: {
                url: '/author-autocomplete',
                queryKey: 'q'
            },
            minLength: 3
        });

        // Get initial state from hidden input
        const initialRole = $('#authorRole').val();
        console.log("Setting up with initialRole:", initialRole);
        if (initialRole === 'EDITOR') {
            console.log("Setting isEditor to checked");
            $('#isEditor').prop('checked', true);
        }

        // Handle changes
        $('#isEditor').change(function() {
            const newRole = this.checked ? 'EDITOR' : 'AUTHOR';
            console.log("Checkbox changed, setting role to:", newRole);
            $('#authorRole').val(newRole);
        });
    });
</script>
{% endblock %}
